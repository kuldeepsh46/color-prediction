@extends('Layout.admindashboard')@section('css')@endsection@section('content')    <div class="content-wrapper">        <div class="page-header">            <h3 class="page-title">                <span class="page-title-icon bg-gradient-primary text-white me-2">                    <i class="mdi mdi-home"></i>                </span> All Tickets            </h3>        </div>        <div class="row">            <div class="col-lg-12 grid-margin stretch-card">                <div class="card">                    <div class="card-body">                        <h4 class="card-title">All Tickets</h4>                        </p><div class="modal fade view-ticket-modal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">  <div class="modal-dialog modal-lg">    <div class="modal-content">      <div class="modal-header">        <h4 class="modal-title" id="myLargeModalLabel">View Ticket</h4>        <button type="button" class="close" data-dismiss="modal" aria-label="Close">          <span aria-hidden="true">Ã—</span>        </button>      </div>      <div class="modal-body">        <div class='chatSection'></div>        <input type='text' id='ticketReply' name='ticketReply' />        <button class='btn btn-sm btn-success view-ticket' onclick='sendReply();'>Send</button>      </div>    </div>  </div></div>                        <table class="table table-bordered">                            <thead>                                <tr>                                    <th>Sr.No</th>                                    <th>User id</th>                                    <th>Name</th>                                                                        <!--<th>Message</th>-->                                                                        <!--<th>Attachments</th>-->                                    <th>Status</th>                                    <th>Created At</th>                                    <th>Action</th>                                                                        <th>Updated By</th>                                </tr>                            </thead>                            <tbody>                                @if (count($allTickets) > 0)                                    @foreach ($allTickets as $ticket)                                    <tr>                                        <td>{{$ticket[0]['id']}}</td>                                        <td>{{$ticket[0]['userId']}}</td>                                        <td>{{$ticket[0]['name']}}</td>                                        <td>                                            @if($ticket[0]['status'] == 0)                                            Processing                                            @else                                            Closed                                            @endif                                        </td>                                        <td>{{$ticket[0]['created_at']}}</td>                                        <td>                                            <button class="btn btn-sm btn-success view-ticket" onclick="viewTicket('<?php echo htmlspecialchars(json_encode($ticket)); ?>');">View Ticket</button>                                            @if($ticket[0]['status'] == 0)                                            <button class="btn btn-sm btn-danger close-ticket" onclick="closeTicket('<?php echo $ticket[0]['ticketId'] ?>');">Close Ticket</button>                                            @endif                                        </td>                                    </tr>                                    @endforeach                                @else                                                                @endif                            </tbody>                        </table>                    </div>                </div>            </div>        </div>    </div>    <!-- content-wrapper ends -->@endsection@section('js')    <script>    $('.view-ticket-modal').find('.close').click(() => {        $('.chatSection').html('');        $('.view-ticket-modal').removeClass('show');        $('.view-ticket-modal').css('display', 'none');    })        function viewTicket(ticketData) {            // console.log(ticketData)            if (ticketData.includes("\n")) {    ticketData = ticketData.replace(/\n/g, '\\n');}            var ticketData = JSON.parse(ticketData);            // console.log(ticketData)            $('.view-ticket-modal').addClass('show');            $('.view-ticket-modal').css('display', 'block');            $('.chatSection').prepend("<input type='hidden' name='ticketId' id='ticketId' value='"+ticketData[0].ticketId+"' /><span class='senderName'>"+ticketData[0].name+"</span>")            ticketData.forEach((item) => {                if(item.userType == 1 && item.message != null) {                    $(".chatSection").append("<div class='senderMsg admin'>"+item.message+"</div>");                } else {                    if(item.message != null) {                        $(".chatSection").append("<div class='senderMsg user'>"+item.message+"</div>");                    }                }            });        }        function sendReply() {            let formData = new FormData();                        var ticketId = $('#ticketId').val();            formData.append('ticketId', ticketId);                        formData.append('ticketReply', $('#ticketReply').val());            formData.append('_token', '{{ csrf_token() }}');                        $.ajax({                url: "{{ url('admin/reply/ticket') }}",                type: 'POST',                data: formData,                processData: false,                contentType: false,                success: function(response) {                    $('#ticketReply').val('');                    var ticketData = response.data[ticketId];                    $(".chatSection").html('');                    ticketData.forEach((item) => {                        if(item.userType == 1 && item.message != null) {                            $(".chatSection").append("<div class='senderMsg admin'>"+item.message+"</div>");                        } else {                            if(item.message != null) {                                $(".chatSection").append("<div class='senderMsg user'>"+item.message+"</div>");                            }                        }                    });                },                error: function(error) {                }            });        }        function closeTicket(ticketId) {            let formData = new FormData();            formData.append('ticketId', ticketId);            formData.append('_token', '{{ csrf_token() }}');                        apex("POST", "{{ url('admin/close/ticket') }}", formData, '', "/admin/all-tickets", "#");                        setTimeout(() => {                location.reload();            }, 200);        }    </script>@endsection